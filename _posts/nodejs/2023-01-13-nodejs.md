---
title:  "Node.js 기본 개념"
excerpt: Node.js 기본 개념 정리
categories:
  - nodejs
---

## Node.js
노드는 크롬 V8 자바스크립트 엔진으로 빌드 된 비동기 이벤트 주도 자바스크립트 런타임(환경)으로써 확장성 있는 네트워크 애플리케이션을 만들 수 있도록 설계되었다.

- 노드는 자바스크립트를 웹 브라우저로 부터 독립시켜 서버에서도 사용할 수 있도록 만든 프로그램이다.
- 노드는 서버사이드 스크립트 언어가 아니라, 프로그램이다.
- 오늘날 OS 스레드가 일반적으로 사용하는 동시성 모델과는 대조된다. 스레드 기반의 네트워크는 상대적으로 비효율적이고 사용하기가 어렵다.
- 노드는 잠금이 없으므로 사용자는 프로세스의 교착상태에 대해서 걱정할 필요가 없다. 노드에서 I/O를 직접 수행하는 함수는 거의 없으므로 프로세스는 블로킹 되지 않는다. 아무것도 블로킹 되지 않으므로 확장성 있는 시스템을 개발하는 게 쉽다.
- 노드는 스레드를 사용하지 않도록 설계되지만 멀티 코어 환경의 장점을 얻을 수도 있다. `child_process.fork()` API를 사용해서 자식 프로세스를 생성할 수 있다. 같은 인터페이스로 만들어진 `cluster`를 사용하면 다수의 코어에 로드 밸런싱이 가능하도록 프로세스 간에 소켓을 공유할 수도 있다.

## 자바스크립트 런타임
- 런타임이란 특정 언어로 만든 프로그램을 실행할 수 있는 환경을 말한다.
- 노드는 자바스크립트 프로그램을 컴퓨터에서 실행할 수 있게 하는 자바스크립트 실행기이다.

## 이벤트 기반
- 이벤트 기반이란 이벤트가 발생할 때 미리 지정해둔 작업을 수행하는 방식을 말한다. 즉, 특정 이벤트가 발생할 때 무엇을 할지 미리 등록해두고, 이를 이벤트 리스너에 콜백함수로 등록한다. 이후 이벤트가 발생하면 리스너에 등록해둔 콜백함수를 호출하며, 이벤트가 끝난 후 노드는 다음 이벤트가 발생할 때 까지 대기한다.
- 노드는 V8 과 더불어 libuv 라는 라이브러리를 사용한다. libuv 는 노드의 특성인 이벤트 기반, 논 블로킹 I/O 모델을 구현하고 있다.

## 이벤트 루프
- 이벤트 루프는 가능하다면 언제나 시스템 커널에 작업을 떠넘겨서 자바스크립트가 싱글스레드임에도 불구하고 노드가 논 블로킹 I/O 작업을 수행하도록 해준다.
- 이벤트 루프는 여러 이벤트가 동시에 발생했을 때 어떤 순서로 콜백함수를 호출할지를 판단한다.
- 이벤트 루프의 역할은 콜 스택과 콜백 큐를 주시하는 것이다. 콜 스택이 비어있으면 콜백 큐의 콜백을 스택에 쌓아 효과적으로 실행할 수 있게한다.

## 블로킹과 논블로킹
- 블로킹은 노드 프로세스에서 추가적인 자바스크립트의 실행을 위해 자바스크립트가 아닌 작업이 완료될 때까지 기다려야만 하는 상황이다. 이는 이벤트 루프가 블로킹 작업을 하는 동안 자바스크립트 실행을 계속할 수 없기 때문이다. 
- 노드에서 I/O 등의 자바스크립트가 아닌 작업을 기다리는 것보다 CPU 작업 때문에 나쁜 성능을 보여주는 자바스크립트는 보통 블로킹이라고 부르지 않는다.
- libuv를 사용하는 노드 표준 라이브러리의 동기메서드가 가장 대표적인 블로킹 작업이다. 네이티브 모듈도 블로킹 메서드를 가질 수 있다.
- 노드 표준 라이브러리의 모든 I/O 메서드는 논블로킹인 비동기 방식을 제공하고 콜백 함수를 받는다. 일부 메서드는 같은 작업을 하는 블로킹 메서드도 가지는데 이는 이름 마지막에 `Sync`가 붙는다.

#### 동기
  
```js
const fs = require('fs');
const data = fs.readFileSync('/file.md'); // 파일을 읽을 때까지 여기서 블로킹.
console.log(data);
moreWork(); // console.log 이후에 실행.
```  

자바스크립트 실행이 블로킹되는 단점이 있다. 그리고 오류가 발생하면 반드시 처리해주어야 한다. 그렇지 않으면 프로세스가 죽는다.

#### 비동기
  
```js
const fs = require('fs');
fs.readFile('/file.md', (err, data) => {
  if(err) throw err;
  console.log(data);
});
moreWork(); // console.log 이전에 실행.
```  

`fs.readFile()`가 논블로킹이므로 계속 자바스크립트를 실행하고 `moreWork()`가 먼저 호출될 것이다. 파일 읽기가 완료되기를 기다리지 않고 `moreWork()`를 실행할 수 있도록 한 것은 높은 스루풋(처리 능력)을 가능하게 하는 핵심이다.

## 싱글 스레드
- 자바스크립트 코드는 동시에 실행될 수 없는데, 그 이유는 노드가 싱글 스레드 기반이기 때문이다. 노드는 싱글 스레드, 논 블로킹 모델로 스레드가 혼자서 일을 처리하지만 이전 작업이 완료될 때까지 대기하지 않고 다음 작업을 수행한다.
- 이러한 특성 때문에 CPU 부하가 적은 I/O 요청이 많이 발생하면 노드를 서버로 사용하는 것이 좋다. 하지만 우리가 작성한 코드가 스레드 하나에서 처리되기 때문에 CPU 부하가 큰 작업에는 적합하지 않다.

## 동시성과 스루풋(처리 능력)
- 노드에서 자바스크립트 실행이 싱글 스레드이므로 동시성은 이벤트 루프의 능력을 의미한다.
- 동시에 실행되어야 하는 모든 코드는 자바스크립트가 아닌 작업이 일어나는 동안 이벤트 루프가 게속 실행될 수 있도록 해야 한다.
- 데이터베이스 I/O 작업의 경우. 논블로킹 비동기 작업을 사용하면 요청마다 다른 요청을 처리할 수 있게 된다. 그래서 블로킹 메서드 대신 논블로킹 메서드를 사용하면 성능이 향상된다.

###### Reference

- https://nodejs.org/ko/about/

- https://nodejs.org/ko/docs/guides/blocking-vs-non-blocking/